<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
          integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
</head>
<body>
<div>
    头部
</div>
<div>
    <div><button type="button" onclick="do_del_batch()">批量删除</button></div>
    <div>
        <table id="table" class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                <td><input type="checkbox" name="cb_select_all"></td>
                <td>序号</td>
                <td>书名</td>
                <td>日期</td>
                <td>单价</td>
                <td>数量</td>
                <td>操作</td>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<script src="../js/mock.js"></script>
<script>
    /**
     * 使用Mock产生随机的测试数据
     */
    function init_data() {
        return Mock.mock({
            "array|10": [
                {
                    "id|+1": 1,
                    "name": "@string(1, 5)",
                    "create_date": "@date",
                    "price": "@float(40, 200, 2, 2)",
                    "count": "@integer(1, 10)"
                }
            ]
        });
    }

    let books = init_data().array;
    // let {array:books} = init_data(); // 解构写法，ES6新增

    /**
     * 获取表格的tbody标签
     * @param selector
     * @returns {any}
     */
    function get_tbody(selector) {
        // 获取元素
        let table = document.querySelector(selector);
        // 获取tbody
        let tbody = table.querySelector("tbody");
        return tbody;
    }

    /**
     * 绘制表格
     * @param data  表格的数据，要求必须是数组
     * @param selector 表格元素的选择器
     */
    function render_table(data, selector) {
        if (!Array.isArray(data)) {
            throw new Error("data 必须是一个数组");
        }
        if (selector == null) {
            throw new Error("selector 选择器不能为空");
        }
        let tbody = get_tbody(selector);
        // 遍历数据
        data.forEach((item, index) => {
            let tr = `
                <tr>
                    <td><input type="checkbox" name="cb_select" value="${item.id}" /></td>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.create_date}</td>
                    <td>${item.price}</td>
                    <td>
                        <button type="button">-</button>
                        <span>${item.count}</span>
                        <button type="button">+</button>
                    </td>
                    <td>
                        <button type="button">编辑</button>
                        <!--行内JS绑定的事具体的只能传原始数据类型，引用数据类型都object文字-->
                        <button type="button" onclick="do_del(this, ${index}, ${item.id})">删除</button>
                    </td>
                </tr>`;

            tbody.insertAdjacentHTML("beforeend", tr);
        })
    }

    let selector = "#table";
    render_table(books, selector)

    /**
     * 删除功能
     * @param self  触发事件的元素对象
     * @param index  对应的数组中的元素索引
     * @param id  对应的数据中的id属性
     */
    function do_del(self, index, id) {
        console.log(self)
        // 删除确认
        let result = confirm("确认删除序号为" + id + "的数据");
        if (!result) {
            return; // 取消就什么都不干
        }
        // 一个单纯的dom元素删除，实际开发不会
        // self.parentNode.parentNode.remove();
        // 删除数据，然后重新渲染表格
        books.splice(index, 1)
        // 刷新表格
        update_table(books, selector);
    }

    /**
     * 刷新表格
     * @param data
     * @param selector
     */
    function update_table(data, selector) {
        // 清空表格
        clear(selector)
        // 绘制表格
        render_table(data, selector)
    }

    function clear(selector) {
        let tbody = get_tbody(selector);
        while (tbody.hasChildNodes()) {
            tbody.firstChild.remove()
        }
    }

    /**
     * 批量删除
     */
    function do_del_batch() {
        // 获取所有选中的checkbox
        let cbs = document.querySelectorAll("input[name='cb_select']:checked");
        Array.from(cbs).forEach((item) => {
            console.log(item)
            console.log(books)
            console.log(books['id'].indexOf(item.value))
            // console.log(typeof item.value);
            // 根据id找到数据的索引
            let del_index = books.findIndex((subItem) => subItem.id == item.value);
            // 根据索引进行删除
            books.splice(del_index, 1);
        });

        update_table(books, selector);
    }
</script>
</body>
</html>